#version: '3.8'

services:
  postgres:
    image: postgres:16-alpine
    container_name: minecraft-postgres
    environment:
      POSTGRES_DB: minecraft_builds
      POSTGRES_USER: minecraft
      POSTGRES_PASSWORD: minecraft_password
    ports:
      - "127.0.0.1:5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U minecraft -d minecraft_builds"]
      interval: 10s
      timeout: 5s
      retries: 5

  nginx:
    build:
      context: .
      dockerfile: nginx.Dockerfile
      platforms:
        - linux/amd64
        - linux/arm64
    image: ghcr.io/wmill/minecraft-api-nginx:latest  # Add this
    container_name: minecraft-nginx-gateway
    environment:
      # Escape $ as $$ so docker-compose does not interpolate.
      # This is changed on deploy
      - BASIC_AUTH_HTPASSWD=${HTPASSWD}
    ports:
      - "80:80"
    restart: unless-stopped

  minecraft:
    build:
      context: .
      dockerfile: minecraft.Dockerfile
      platforms:
        - linux/amd64
        - linux/arm64
    image: ghcr.io/wmill/minecraft-api:latest  # Add this
    container_name: minecraft-fabric-server
    ports:
      - "25565:25565"
    volumes:
      - minecraft_world:/minecraft/world
      - minecraft_logs:/minecraft/logs
    environment:
      # Database connection
      - DB_HOST=postgres
      - DB_PORT=5432
      - DB_NAME=minecraft_builds
      - DB_USER=minecraft
      - DB_PASSWORD=minecraft_password
      # JVM memory settings
      - JAVA_OPTS=-Xmx2G -Xms1G -XX:+UseG1GC -XX:+UseStringDeduplication
      # Optional: Set server properties via environment
      # - SERVER_PORT=25565
      # - MAX_PLAYERS=20
      # - DIFFICULTY=normal
    restart: unless-stopped
    stdin_open: true
    tty: true
    deploy:
      resources:
        limits:
          memory: 3G
        reservations:
          memory: 1G

  mcp:
    build:
      context: ./mcp
      dockerfile: Dockerfile
      platforms:
        - linux/amd64
        - linux/arm64
    image: ghcr.io/wmill/minecraft-mcp:latest
    container_name: minecraft-mcp-server
    ports:
      - "3737:3737"
    environment:
      - BASE_URL=http://minecraft:7070
    depends_on:
      - minecraft
    restart: unless-stopped

volumes:
  postgres_data:
    driver: local
  minecraft_world:
    driver: local
  minecraft_logs:
    driver: local
